@page "/phrases-textbook"
@inject IDialogService DialogService
@inject CommonService CommonService
@inject NavigationManager NavigationManager

<RequireAuth>

<MudToolBar>
    <MudSelect @bind-Value="vm.ScopeFilter">
        @foreach (var item in SettingsViewModel.ScopePhraseFilters)
        {
            <MudSelectItem Value="@item">@item</MudSelectItem>
        }
    </MudSelect>
    <MudTextField @bind-Value="vm.TextFilter" Label="Filter" Variant="Variant.Text"></MudTextField>
    <MudButton Variant="Variant.Filled" StartIcon="fa fa-sync" Color="Color.Primary" OnClick="@OnRefresh">Refresh</MudButton>
    <MudButton Variant="Variant.Filled" StartIcon="fa fa-book" Color="Color.Primary">Dictionary</MudButton>
</MudToolBar>

<MudTable ServerData="@ServerReload" RowsPerPage="@vm.PageSize" Loading="@vm.IsBusy" @ref="table">
    <HeaderContent>
        <MudTh>ID</MudTh>
        <MudTh>TEXTBOOKNAME</MudTh>
        <MudTh>UNIT</MudTh>
        <MudTh>PART</MudTh>
        <MudTh>SEQNUM</MudTh>
        <MudTh>PHRASEID</MudTh>
        <MudTh>PHRASE</MudTh>
        <MudTh>TRANSLATION</MudTh>
        <MudTh>ACTIONS</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd>@context.ID</MudTd>
        <MudTd>@context.TEXTBOOKNAME</MudTd>
        <MudTd>@context.UNITSTR</MudTd>
        <MudTd>@context.PARTSTR</MudTd>
        <MudTd>@context.SEQNUM</MudTd>
        <MudTd>@context.PHRASEID</MudTd>
        <MudTd>@context.PHRASE</MudTd>
        <MudTd>@context.TRANSLATION</MudTd>
        <MudTd>
            <MudTooltip Text="Delete" Arrow="true" Placement="Placement.Top">
                <MudFab StartIcon="fa fa-trash" Color="Color.Secondary"/>
            </MudTooltip>
            <MudTooltip Text="Edit" Arrow="true" Placement="Placement.Top">
                <MudFab StartIcon="fa fa-edit" Color="Color.Primary" OnClick="@(() => ShowDetailDialog(context))"/>
            </MudTooltip>
            <MudTooltip Text="Speak" Arrow="true" Placement="Placement.Top">
                <MudFab StartIcon="fa fa-volume-up" Color="Color.Primary"/>
            </MudTooltip>
            <MudTooltip Text="Copy" Arrow="true" Placement="Placement.Top">
                <MudFab StartIcon="fa fa-copy" Color="Color.Primary" OnClick="@(() => CopyPhrase(context.PHRASE))"/>
            </MudTooltip>
            <MudTooltip Text="Google Phrase" Arrow="true" Placement="Placement.Top">
                <MudFab StartIcon="fab fa-google" Color="Color.Primary" OnClick="@(() => GooglePhrase(context.PHRASE))"/>
            </MudTooltip>
        </MudTd>
    </RowTemplate>
    <PagerContent>
        <MudTablePager PageSizeOptions="@vm.vmSettings.USROWSPERPAGEOPTIONS.ToArray()" />
    </PagerContent>
</MudTable>

</RequireAuth>

@code {
    PhrasesUnitViewModel vm = new(App.vmSettings, false, false, true);
    MudTable<MUnitPhrase> table;

    protected override void OnInitialized()
    {
        vm.PropertyChanged += (_, __) => InvokeAsync(StateHasChanged);
        vm.WhenAnyValue(x => x.TextFilter, x => x.ScopeFilter, x => x.TextbookFilter).Subscribe(_ => table?.ReloadServerData());
    }

    async Task<TableData<MUnitPhrase>> ServerReload(TableState state, CancellationToken token)
    {
        vm.PageNo = state.Page + 1;
        vm.PageSize = state.PageSize;
        await vm.ReloadAsync();
        return new TableData<MUnitPhrase> {TotalItems = vm.ItemCount, Items = vm.PhraseItems};
    }

    async Task ShowDetailDialog(MUnitPhrase item)
    {
        var itemEdit = new MUnitPhrase();
        item.CopyProperties(itemEdit);
        var parameters = new DialogParameters<PhrasesTextbookDetail> { { x => x.Item, itemEdit } };
        var dialog = await DialogService.ShowAsync<PhrasesTextbookDetail>("Simple Dialog", parameters);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
        }
    }
    
    async Task OnRefresh() =>
        NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);

    async Task CopyPhrase(string phrase) =>
        await CommonService.WriteTextAsync(phrase);

    async Task GooglePhrase(string phrase) =>
        await CommonService.GoogleStringAsync(phrase);
}
